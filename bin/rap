#!/usr/bin/env ruby
# usage: rap taskname {options} [args]

$:.unshift "#{File.dirname(__FILE__)}/../lib"
require 'tap/declarations'

# setup the environment
begin
  
  # handle super options
  $DEBUG = true if ARGV.delete('-d-')
  env = Tap::Exe.instantiate
  env.unshift(Tap::Declarations.env)

  task_file = File.expand_path('Tapfile')
  if File.exists?(task_file)
    env.loads.unshift(task_file)
    env.tasks.register(Dir.pwd, 'Tapfile')
  end
  
rescue(Tap::Env::ConfigError)
  # catch errors and exit gracefully
  # (errors usu from gem loading errors)
  puts $!.message
  exit(1)
end

#
# setup after script
#

at_exit do
  begin
    eval(env.after) if env.after != nil
  rescue(Exception)
    puts "Error in after script."
    env.handle_error($!)
    exit(1)
  end
end

#
# run before script
#

begin
  eval(env.before) if env.before != nil
rescue(Exception)
  puts "Error in before script."
  env.handle_error($!)
  exit(1)
end 

#
# run rap
#

module Tap
  module Tasks
    autoload(:Rake, 'tap/tasks/rake')
  end
end

begin
  env.activate
  
  case ARGV[0]
  when '--help', nil, '-T'
    rap_template = %Q{<% if count > 1 && !entries.empty? %>
<%= env_name %>:
<% end %>
<% entries.each do |name, const| %>
<%   desc = if const.require_path == nil # should be a declaration %>
<%     manifest = const.constantize.lazydoc[const.name]['manifest'] %>
<%     next if manifest == nil || manifest.subject.empty? %>
<%     manifest.subject %>
<%   else %>
<%     const.document[const.name]['manifest'] %>
<%   end %>
  <%= name.ljust(width) %><%= desc.empty? ? '' : '  # ' %><%= desc %>
<% end %>}

    puts Tap::Support::Lazydoc.usage(__FILE__)
    puts
    puts "===  tap tasks ==="
    puts env.summarize(:tasks, rap_template)
    puts
    puts "=== rake tasks ==="
    Tap::Tasks::Rake.new.enq('-T')
    Tap::App.instance.run
    
    # this is not currently reached as rake exits on -T
    puts
    puts "version #{Tap::VERSION} -- #{Tap::WEBSITE}"
    exit
  else
    queues = env.build(ARGV) do |args|
      warn "warning: implict rake for [#{args.join(' ')}]"
      Tap::Tasks::Rake
    end
    ARGV.clear

    if queues.empty?
      puts "no task specified"
      exit
    end
  
    env.set_signals
    env.run(queues)
  end
  
rescue
  env.handle_error($!)
end

exit(0)