#!/usr/local/bin/ruby

require "#{File.dirname(__FILE__)}/../lib/tap.rb"

# setup the environment
begin
  
  $DEBUG = true if ARGV.delete('-d-')
  env = Tap::Exe.instantiate
  
  # add the DEFAULT_TASK_FILE if it exists
  task_file = File.expand_path('tapfile.rb')
  if File.exists?(task_file)
    env.requires.unshift(task_file)
    env.manifest(:tasks).search_paths << [Dir.pwd, task_file]
  end
  
rescue(Tap::Env::ConfigError)
  # catch errors and exit gracefully
  # (errors usu from gem loading errors)
  puts $!.message
  exit(1)
end

#
# setup after script
#

at_exit do
  begin
    eval(env.after) if env.after != nil
  rescue(Exception)
    puts "Error in after script."
    env.handle_error($!)
    exit(1)
  end
end

#
# run before script
#

begin
  eval(env.before) if env.before != nil
rescue(Exception)
  puts "Error in before script."
  env.handle_error($!)
  exit(1)
end 

#
# run rap
#

module Tap
  module Tasks
    autoload(:Rake, 'tap/tasks/rake')
  end
end

begin
  env.activate
  
  queues = env.build(ARGV) {|args| Tap::Tasks::Rake }
  ARGV.clear

  if queues.empty?
    puts "no task specified"
    exit
  end
  
  env.set_signals
  env.run(queues)
  
rescue
  env.handle_error($!)
end

exit(0)