#!/usr/bin/env ruby
# usage: tap [workflow...] [--- tapfile]
#
# workflows:
#   tap load 'goodnight moon' --: dump   # a simple workflow
#
# help:
#   tap --help                           # prints this help
#

$DEBUG = true if ENV['TAP_DEBUG'] == 'true'
require 'tap'
require 'tap/parser'

app = Tap.setup
parser = Tap::Parser.new

if ARGV == ['--help']
  puts Lazydoc.usage(__FILE__)
  puts "\nversion #{Tap::VERSION} -- #{Tap::WEBSITE}"
  exit(0)
end

loop do
  break if ARGV.empty?
  parser.parse!(ARGV)
  parser.build_to(app)
  
  break if ARGV.empty?
  psr = ConfigParser.new(app.config, 
    :option_break => Tap::Parser::BREAK, 
    :keep_break => true, 
    :clear_config => false, 
    :add_defaults => false
  )
  psr.add(Tap::App.configurations)
  psr.scan(ARGV) do |file|
    app.call('sig' => 'load', 'args' => [file])
  end
end

begin
  app.run
rescue(Exception)
  YAML.dump(app.serialize, $stderr)
  raise
end

exit(0)