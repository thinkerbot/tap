#!/usr/bin/env ruby
# usage: tap <command> {options} [args]
#
# Launches a tap command.
#
# examples:
#   tap generate root .                  # generates a root dir
#   tap run taskname --option input      # runs the 'taskname' task
#
# help:
#   tap --help                           # prints this help
#   tap command --help                   # prints help for 'command'
#

require "tap"

begin
  app = Tap.setup
rescue(Tap::Env::ConfigError)
  # catch errors and exit gracefully
  # (errors usu from gem loading errors)
  puts $!.message
  exit(1)
end

loop do
  break if ARGV.empty?
  app.parse!(ARGV)
  
  break if ARGV.empty?
  psr = ConfigParser.new(app.config, 
    :option_break => Tap::Parser::BREAK, 
    :keep_break => true, 
    :clear_config => false, 
    :add_defaults => false
  )
  psr.add(Tap::App.configurations)
  psr.scan(ARGV) do |file|
    app.call('sig' => 'exec', 'args' => [file])
  end
end

app.run
exit(0)